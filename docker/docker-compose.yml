services:
  shape-shifter:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        # Build-time arguments for frontend
        # These come from docker/data/frontend.env or can be overridden
        - VITE_API_BASE_URL=${VITE_API_BASE_URL:-}
        - VITE_ENV=${VITE_ENV:-production}
        - VITE_ENABLE_ANALYTICS=${VITE_ENABLE_ANALYTICS:-false}
        - VITE_ENABLE_DEBUG=${VITE_ENABLE_DEBUG:-false}
    image: shape-shifter:latest
    container_name: shape-shifter
    ports:
      - "${HOST_PORT:-8012}:8012"
    env_file:
      # Load all environment variables from backend.env
      - ./data/backend.env
      
    volumes:
      # Mount local data directories from docker/data/
      - ./data/projects:/app/projects
      - ./data/logs:/app/logs
      - ./data/output:/app/output
      - ./data/backups:/app/backups
      - ./data/tmp:/app/tmp
      
      # Mount .pgpass for PostgreSQL authentication (if exists)
      - ./data/.pgpass:/root/.pgpass:ro
      
      # Optional: mount input directory for development
      # - ./data/input:/app/input
      
    restart: unless-stopped
    
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8012/').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
