metadata:
  name: arbodat-test
  type: shapeshifter-project
  description: Configuration for importing data from ArboDat database into SEAD.
  version: 1.0.0
  default_entity: survey
entities:
  abundance:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: abundance_id
    keys: "@value: entities.analysis_entity.keys"
    columns: ["rAnzahl", "rGewicht", "geschätzt", "rFrag", "Multiplikator", "FAnzahl", "FFragmente", "FGewicht", "EDatProb", "AnmFrakt"]
    query: select [Projekt], [Befu], [ProbNr], [PCODE], [Fraktion], [cf], [RTyp], [Zust], [rAnzahl], [rGewicht], [geschätzt], [rFrag], [Multiplikator], [FAnzahl], [FFragmente], [FGewicht], [EDatProb], [AnmFrakt] from [Details];
    extra_columns:
      abundance: "FAnzahl"
    foreign_keys:
    - entity: analysis_entity
      local_keys: "@value: entities.analysis_entity.keys"
      remote_keys: "@value: entities.analysis_entity.keys"
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: abundance_element
      local_keys: ["RTyp"]
      remote_keys: ["RTyp"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    depends_on: ["analysis_entity"]
  abundance_element:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: abundance_element_id
    keys: ["RTyp"]
    columns: ["Resttyp", "RTypGrup", "RTypNr"]
    extra_columns:
      element_name: "RTyp"
      element_description: "Resttyp"
    query: "select [RTyp], [Resttyp], [RTypGrup], [RTypNr] from [RTyp];"
    foreign_keys:
    - entity: abundance_element_group
      local_keys: ["RTypGrup"]
      remote_keys: ["RTypGrup"]
    depends_on: ["abundance_element_group"]
  abundance_element_group:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: abundance_element_group_id
    keys: ["RTypGrup"]
    columns: ["RTypGrup_EN", "Nummer"]
    query: |
      select [RTypGrup], [RTypGrup_EN], [Nummer]
      from [RtypGruppen];
    depends_on: []
  abundance_modification:
    source: abundance
    surrogate_id: abundance_modification_id
    keys: ["abundance_id"]
    columns: ["Zust"]
    foreign_keys:
    - entity: modification_type
      local_keys: ["Zust"]
      remote_keys: ["Zust"]
    depends_on: ["abundance"]
  abundance_property:
    source: abundance
    surrogate_id: abundance_property_id
    keys: []
    columns: "@value: entities.abundance_property_type.arbodat_codes + ['abundance_id']"
    unnest:
      id_vars: ["abundance_id"]
      value_vars: "@value: entities.abundance_property_type.arbodat_codes"
      var_name: abundance_property_type
      value_name: abundance_property_value
    foreign_keys:
    - entity: abundance_property_type
      local_keys: ["abundance_property_type"]
      remote_keys: ["arbodat_code"]
      # - entity: analysis_entity      #   local_keys: ["arbodat_analysis_entity_id"]
      #   remote_keys: ["arbodat_analysis_entity_id"]
    drop_empty_rows:
      abundance_property_value: [null, ""]
    drop_duplicates: true
    depends_on: ["abundance", "abundance_property_type"]
  abundance_property_type:
    source:
    type: fixed
    keys: ["abundance_property_type_id"]
    surrogate_id: abundance_property_type_id
    surrogate_name: abundance_property_type
    columns: ["abundance_property_type", "description", "arbodat_code"]
    values:
    - ["raw_count", "Number of plant remains of the corresponding taxon", "rAnzahl"]
    - ["raw_weight", "Weight of plant remains of the corresponding taxon (mainly charcoal)", "rGewicht"]
    - ["estimated_amount", "Semi-quantitatively estimated plant remains of the corresponding taxon", "geschätzt"]
    - ["raw_fragments", "Fragments (if present)", "rFrag"]
    - ["multiplier", "Total weight / evaluated weight", "Multiplikator"]
    - ["extrapolated_count", "Extrapolated count", "FAnzahl"]
    - ["extrapolated_fragments", "Extrapolated fragments", "FFragmente"]
    - ["extrapolated_weight", "Extrapolated weight", "FGewicht"]
    - ["entry_date", "Entry date", "EDatProb"]
    - ["note", "Note", "AnmFrakt"]
    arbodat_codes: ["rAnzahl", "rGewicht", "geschätzt", "rFrag", "Multiplikator", "FAnzahl", "FFragmente", "FGewicht", "EDatProb", "AnmFrakt"]
    depends_on: []
  analysis_entity:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: analysis_entity_id
    keys: ["Projekt", "Befu", "ProbNr", "PCODE", "Fraktion", "cf", "RTyp", "Zust"]
    columns: []
    query: select [Projekt], [Befu], [ProbNr], [PCODE], [Fraktion], [cf], [RTyp], [Zust] from [Details];
    foreign_keys:
    - entity: sample
      local_keys: ["Projekt", "Befu", "ProbNr"]
      remote_keys: ["Projekt", "Befu", "ProbNr"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
      how: "left"
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
    - entity: method
      local_keys: ["Fraktion"]
      remote_keys: ["arbodat_code"]
      how: "left"
      constraints:
        allow_unmatched_left: false
          # allow_null_keys: false
        cardinality: "many-to-one"
    depends_on: ["method", "taxa", "sample"] #, "modification_type", "remain_type"]

  archaeological_period:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: archaeological_period_id
    keys: ["ArchDat"]
    columns: ["ArchDat", "Beschreibung", "Epoche", "Nummer"]
    query: "select [ArchDat], [Beschreibung], [Epoche], [Nummer] from [ArchDat] ;"
    foreign_keys:
    - entity: epoch
      local_keys: ["Epoche"]
      remote_keys: ["Epoche"]
    depends_on: ["epoch"]
  chronological_period:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: chronological_period_id
    keys: ["ChronoDat"]
    columns: ["ChronoDat", "Beschreibung", "Nummer", "von", "bis"]
    query: "select [ChronoDat], [Beschreibung], [Nummer], [von], [bis] from [ChronoDat] ;"
    depends_on: []
  contact:
    source: _project_contact
    surrogate_id: contact_id
    keys: []
    columns: ["contact_name", "contact_type"]
    append:
      source:
      data_source: arbodat_data
      check_column_names: false
      type: sql
      query: |
        select [BotBest], "BotBest" from [Befunde] where [BotBest] is not null ;
    foreign_keys:
    - entity: contact_type
      local_keys: ["contact_type"]
      remote_keys: ["arbodat_code"]
    drop_duplicates: true
    depends_on: ["contact_type", "_project_contact"]
  contact_type:
    source:
    surrogate_id: contact_type_id
    surrogate_name: contact_type
    keys: ["arbodat_code"]
    columns: ["contact_type", "description", "arbodat_code"]
    type: fixed
    values:
    - ["Archaeologist", "Name of scientist responsible for processing the archaeological material", "ArchBear"]
    - ["Botanist", "Name of scientist responsible for the botanical determination (possibly several persons)", "BotBear"]
    - ["Author(s) ", "Publication/manuscript/short report", "Aut"]
    - ["Bot. Determination", "Name(s) of person(s) responsible for charcoal or seed/fruit determination, etc", "BotBest"]
    - ["Site Director/Institution", "Name of site director and/or institution", "ArchAusg"]
    contact_types: ["ArchAusg", "ArchBear", "BotBear", "Aut", "BotBest"]
  coordinate_method_dimension:
    source:
    keys: []
    surrogate_id: coordinate_method_dimension_id
    columns: ["method_name", "limit_upper", "limit_lower", "arbodat_dimension_code"]
    type: fixed
    values:
    - ["Local or unknown grid", null, null, "KoordX"]
    - ["Local or unknown grid", null, null, "KoordY"]
    - ["Local or unknown grid", null, null, "KoordZ"]
    - ["Altitude above sea level", null, null, "Prob_üNN"]
    foreign_keys:
    - entity: dimension
      local_keys: ["arbodat_dimension_code"]
      remote_keys: ["arbodat_code"]
      how: "left"
    - entity: method
      local_keys: ["method_name"]
      remote_keys: ["method_name"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
      how: "left"
    depends_on: ["dimension", "method"]
  coordinate_system:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: coordinate_system_id
    keys: ["Koordsys"]
    columns: ["Index", "Koordsys", "Bemerkung"]
    query: "select [Index], [Koordsys], [Bemerkung] from [KoordSys] ;"
    depends_on: []
  cultural_group:
    source:
    data_source: arbodat_lookup
    surrogate_id: cultural_group_id
    keys: ["KultGr"]
    columns: ["KultGr", "Cult_EN"]
    type: sql
    query: select KultGr, Cult_EN from Kulturgruppen;
    depends_on: []
  dataset:
    source: analysis_entity
    surrogate_id: dataset_id
    keys: ["Projekt", "Fraktion"]
    columns: []
    extra_columns:
      dataset_type_id:
      dataset_name: "method_name"
      master_set_id: 1
      data_type_id:
      biblio_id:
    foreign_keys:
    - entity: project
      local_keys: ["Projekt"]
      remote_keys: ["Projekt"]
      how: "left"
      contraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: method
      local_keys: ["Fraktion"]
      remote_keys: ["arbodat_code"]
      how: "left"
      constraints:
        allow_unmatched_left: false
          # allow_null_keys: false
        cardinality: "many-to-one"
    drop_duplicates: true
    depends_on: ["method", "project"]
  dataset_contacts:
    source: dataset
    surrogate_id: dataset_contact_id
    keys: ["dataset_id", "Projekt"]
    columns: []
    foreign_keys:
    - entity: _project_contact
      local_keys: ["Projekt"]
      remote_keys: ["Projekt"]
      extra_columns:
        contact_name: "contact_id"
    drop_duplicates: true
    depends_on: ["_project_contact", "dataset", "project"]
  dataset_submission:
    source: dataset
    surrogate_id: dataset_submission_id
    keys: []
    columns: ["dataset_id"]
    extra_columns:
      date_submitted:
      submission_type_id: 1
      notes:
    depends_on: ["dataset"]
  dataset_submission_type:
    source:
    type: fixed
    surrogate_id: dataset_submission_type_id
    keys: []
    columns: ["system_id", "dataset_submission_type_id"]
    values:
    - [1, 4]
    depends_on: []
  dating:
    source:
    data_source: arbodat_data
    surrogate_id: dating_id
    keys: ["Projekt", "Befu", "ProbNr"]
    columns:
    - "Projekt"
    - "Befu"
    - "ProbNr"
    - "Unterprobe"
    - "Labornummer"
    - "Material"
    - "Methode"
    - "Waldkante"
    - "C14-Alter BP"
    - "Standardab C14"
    - "C14 cal"
    - "Dendroalter"
    - "Alter andere"
    - "13C PDB-Wert"
    - "Standardab 13C PDB"
    - "pMC-Wert"
    - "Standardab PMC"
    - "Anmerkungen"
    type: sql
    query: |
      select
        [Projekt],
        [Befu],
        [ProbNr],
        [Unterprobe],
        [Labornummer],
        [Material],
        [Methode],
        [Waldkante],
        [C14-Alter BP],
        [Standardab C14],
        [C14 cal],
        [Dendroalter],
        [Alter andere],
        [13C PDB-Wert],
        [Standardab 13C PDB],
        [pMC-Wert],
        [Standardab PMC],
        [Anmerkungen]
      from [Datierung] ;
    foreign_keys:
    - entity: sample
      local_keys: ["Projekt", "Befu", "ProbNr"]
      remote_keys: ["Projekt", "Befu", "ProbNr"]
    drop_duplicates: true
    depends_on: ["sample"]
  dating_period:
    source:
    data_source: arbodat_data
    surrogate_id: dating_period_id
    keys: "@value: entities.sample.keys"
    columns: "@value: entities.sample.keys + ['ChronoDat', 'ArchDat']"
    type: sql
    query: |
      select distinct [Projekt], [Befu], [ProbNr], [ChronoDat], [ArchDat]
      from [Proben] ;
    foreign_keys:
    - entity: sample
      local_keys: "@value: entities.sample.keys"
      remote_keys: "@value: entities.sample.keys"
    - entity: chronological_period
      local_keys: ["ChronoDat"]
      remote_keys: ["ChronoDat"]
      how: "left"
    - entity: archaeological_period
      local_keys: ["ArchDat"]
      remote_keys: ["ArchDat"]
      how: "left"
    drop_empty_rows: ["ChronoDat", "ArchDat"]
    depends_on: ["sample"]
  dimension:
    source:
    type: fixed
    surrogate_id: "dimension_id"
    keys: []
    columns: ["dimension_name", "dimension_abbrev", "dimension_description", "method_group_id", "unit_id", "arbodat_code"]
    values:
    - ["X/North", "X/N", "X coordinate or Northing in intrinsic units.", 17, 5, "KoordX"]
    - ["X/East", "X/E", "X coordinate or Easting in intrinsic units.", 17, 5, "KoordY"]
    - ["Z/Altitude", "Z/Alt", "Z coordinate or Altitude in intrinsic units.", 17, 5, "KoordZ"]
    - ["Sampling height above sea level", "Sampling ASL", "Sampling height above sea level.", 17, 1, "Prob_üNN"]
    depends_on: []
  epoch:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: epoch_id
    keys: ["Epoche"]
    columns: ["Epoche", "Beschreibung", "Epoch_EN", "Nummer"]
    query: "select [Epoche], [Beschreibung], [Epoch_EN], [Nummer] from [Epochen] ;"
    depends_on: []
  feature:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: feature_id
    keys: ["Projekt", "Befu"]
    columns: ["FlSchn", "BefuTyp", "FustelTyp", "FuTypVermut", "gebäud", "okBefu", "okErh", "BotBest", "BestJa", "Anmerkung"]
    query: select [Projekt], [Befu], [FlSchn], [BefuTyp], [FustelTyp], [FuTypVermut], [gebäud], [okBefu], [okErh], [BotBest], [BestJa], [Anmerkung] from [Befunde]
    drop_duplicates:  ["Projekt", "Befu"]
    foreign_keys:
    - entity: project
      local_keys: ["Projekt"]
      remote_keys: ["Projekt"]
      extra_columns:
        site_id: "site_id"
    - entity: feature_type
      local_keys: ["BefuTyp"]
      remote_keys: ["Befundtyp"]
      how: "left"
    depends_on: ["project"]
  feature_property:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: feature_property_id
    keys: ["Projekt", "Befu"]
    columns: "@value: entities.feature_property_type.values"
    query: select [Projekt], [Befu], [FlSchn], [gebäud], [okBefu], [okErh], [BestJa], [Anmerkung] from [Befunde] ;
    foreign_keys:
    - entity: feature
      local_keys: "@value: entities.feature.keys"
      remote_keys: "@value: entities.feature.keys"
    - entity: feature_property_type
      local_keys: ["feature_property_type"]
      remote_keys: ["arbodat_code"]
      how: "left"
    unnest:
      id_vars: "@value: entities.feature.keys"
      value_vars: "@value: entities.feature_property_type.values"
      var_name: feature_property_type
      value_name: feature_property_value
    drop_duplicates: true
    depends_on: ["feature", "feature_property_type"]
  feature_property_type:
    type: fixed
    keys: []
    surrogate_id: feature_property_type_id
    surrogate_names: feature_property_type
    columns: ["arbodat_code"]
    values: ["gebäud", "okBefu", "okErh", "BestJa", "FlSchn", "Anmerkung"]
    extra_columns:
      feature_property_type: 1
      feature_property_name: 1
      feature_property_description: 1
  feature_type:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: feature_type_id
    keys: []
    columns: ["Befundtyp", "Beschreibung"]
    extra_columns:
      feature_type_name: "Befundtyp"
      description: "Beschreibung"
    query: "select [Befundtyp], [Beschreibung] from [Befundtypen];"
    depends_on: []
  identification_level:
    data_source: sead
    surrogate_id: identification_level_id
    type: sql
    keys: []
    columns: ["identification_level_id", "identification_level_abbrev", "identification_level_name", "notes"]
    drop_duplicates: false
    query: select identification_level_id, identification_level_abbrev, identification_level_name, notes from public.tbl_identification_levels
    depends_on: []
  location:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: location_id
    keys: []
    columns: ["Ort", "Kreis", "Land", "Staat", "FlurStr"]
    query: |
      select distinct [Ort], [Kreis], [Land], [Staat], [FlurStr] from [Projekte] ;
    extra_columns:
      default_lat_dd:
      default_long_dd:
    unnest:
      value_vars: "@value: entities.location.columns"
      var_name: location_type
      value_name: location_name
      id_vars: []
    foreign_keys:
    - entity: location_type
      local_keys: ["location_type"]
      remote_keys: ["location_type"]
    drop_duplicates: ["location_type", "location_name"]
    depends_on: ["location_type"]
  location_type:
    source:
    type: fixed
    surrogate_id: location_type_id
    surrogate_name: location_type
    keys: []
    columns: ["location_type"]
    extra_columns:
      arbodat_code: location_type
    values:
    - ["Ort"]
    - ["Kreis"]
    - ["Land"]
    - ["Staat"]
    - ["FlurStr"]

  master_dataset:
    surrogate_id: master_dataset_id
    type: fixed
    keys: []
    columns: ["master_dataset_id", "contact_id", "biblio_id", "master_name", "master_notes", "url"]
    values: [[1, null, null, "ArboDat Pilot", null, null]]
    depends_on: []
  method:
    type: fixed
    surrogate_id: method_id
    arbodat_codes: ["ORG2,0", "ORG1,0", "ORG0,5", "ORG0,25", "MIN2,0", "MIN1,0", "MIN0,5", "MIN0,25"]
    keys: []
    columns: ["system_id", "method_id", "biblio_id", "description", "method_name", "method_abbrev_or_alt_name", "method_group_id", "arbodat_code"]
    values: [[1, null, null, "Organic remains >2.0 mm", "ORG 2,0", "ORG 2,0", null, "ORG 2,0"], [2, null, null, "Organic remains 1.0-2.0 mm", "ORG 1,0", "ORG 1,0", null, "ORG 1,0"], [3, null, null, "Organic remains 0.5-1.0 mm", "ORG 0,5", "ORG 0,5", null, "ORG 0,5"], [4, null, null, "Organic remains 0.25-0.5 mm", "ORG 0,25", "ORG 0,25", null, "ORG 0,25"], [5, null, null, "Mineral remains >2.0 mm", "MIN 2,0", "MIN 2,0", null, "MIN 2,0"], [6, null, null, "Mineral remains 1.0-2.0 mm", "MIN 1,0", "MIN 1,0", null, "MIN 1,0"], [7, null, null, "Mineral remains 0.5-1.0 mm", "MIN 0,5", "MIN 0,5", null, "MIN 0,5"], [8, null, null, "Mineral remains 0.25-0.5 mm", "MIN 0,25", "MIN 0,25", null, "MIN 0,25"], [9, 105, null, null, "Local or unknown grid", null, null, null], [10, 76, null, null, "Altitude above sea level", null, null, null]] # This data could be also loaded from "Fraktionen" table
    depends_on: []
  method_group:
    data_source: sead
    type: sql
    surrogate_id: method_group_id
    keys: ["method_group_id"]
    columns: ["method_group_id", "group_name", "description"]
    query: select "method_group_id", "group_name", "description" from public.tbl_method_groups
    depends_on: []
  modification_type:
    type: sql
    keys:
    - Zust
    surrogate_id: modification_type_id
    columns:
    - Zust
    - Zustand
    - Nummer
    data_source: arbodat_lookup
    query: "select [Zust], [Zustand], [Nummer]\r\nfrom [Zustand];"
    extra_columns:
      modification_type_name: Zust
      modification_type_description: Zustand
  natural_region:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: natural_region_id
    keys: ["NaturE"]
    columns: ["NaturE", "NaturrEinh", "NatHauptNr"]
    query: "select [NaturE], [NaturrEinh], [NatHauptNr] from [NaturE];"
    foreign_keys:
    - entity: natural_region_group
      local_keys: ["NatHauptNr"]
      remote_keys: ["NatHauptNr"]
    depends_on: ["natural_region_group"]
  natural_region_group:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: natural_region_group_id
    keys: ["NatHauptNr"]
    columns: ["NaturHaupteinheit"]
    query: "select [NatHauptNr], [NaturHaupteinheit] from [NaturHaupt];"
    depends_on: []
  project:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: project_id
    keys: ["Projekt", "Fustel"]
    columns: []
    extra_columns:
      project_name: "Projekt"
      project_type_id: 0
      project_stage_id: 0
      project_abbrev_name:
      description:
    query: select [Projekt], [Fustel] from [Projekte];
    foreign_keys:
    - entity: site
      local_keys: ["Fustel"]
      remote_keys: ["Fustel"]
    depends_on: []
  relative_dating:
    source: sample
    surrogate_id: relative_age_id
    keys: []
    columns: ["Projekt", "Befu", "ProbNr", "ArchDat"]
    extra_columns:
      relative_age_id:
      method_id:
      notes:
      dating_uncertainty_id:
    depends_on: ["sample"]
  sample:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: physical_sample_id
    keys: ["Projekt", "Befu", "ProbNr"]
    columns: ["Projekt", "Befu", "ProbNr", "ProbTyp", "ArchDat", "ChronoDat"]
    query: "select [Projekt], [Befu], [ProbNr], [ProbTyp], [ArchDat], [ChronoDat] from [Proben] ;"
    extra_columns:
      sample_name: "Befu"
      alt_ref_type_id:
    foreign_keys:
    - entity: feature
      local_keys: ["Projekt", "Befu"]
      remote_keys: ["Projekt", "Befu"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: sample_group
      local_keys: ["Projekt", "Befu"]
      remote_keys: ["Projekt", "Befu"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    - entity: sample_type
      local_keys: ["ProbTyp"]
      remote_keys: ["ProbTyp"]
    depends_on: ["feature", "sample_type", "sample_group"]
  sample_coordinate:
    source:
    data_source: arbodat_data
    surrogate_id: sample_coordinate_id
    keys: "@value: entities.sample.keys"
    columns: ["KoordX", "KoordY", "KoordZ", "TiefeBis", "TiefeVon", "Prob_üNN"]
    type: sql
    query: "select [Projekt], [Befu], [ProbNr], [KoordX], [KoordY], [KoordZ], [TiefeBis], [TiefeVon], [Prob_üNN] from [Proben] ;"
    unnest:
      id_vars: "@value: entities.sample.keys"
      value_vars: "@value: entities.sample_coordinate.columns"
      var_name: coordinate_type
      value_name: coordinate_value
    foreign_keys:
    - entity: sample
      local_keys: "@value: entities.sample.keys"
      remote_keys: "@value: entities.sample.keys"
      how: "left"
    - entity: coordinate_method_dimension
      local_keys: ["coordinate_type"]
      remote_keys: ["arbodat_dimension_code"]
      how: "left"
    drop_duplicates: true
    drop_empty_rows: ["coordinate_value"]
    depends_on: ["sample", "dimension", "coordinate_method_dimension"]
  sample_description_type:
    source:
    type: fixed
    surrogate_id: sample_description_type_id
    surrogate_name: type_name
    keys: []
    columns: ["type_name", "type_description", "arbodat_code"]
    type_names: ["Vorfu", "Trocken", "Strat", "Schi", "Quadr", "Plan", "Prob_üNN", "SedProb", "KultGr"]
    values:
    - ["Is mass find?", "Indicates of sample is a mass find.", "Vorfu"]
    - ["Wet/dry", "Ablagerungsbedingungen", "Trocken"]
    - ["Stratigraphy", "Stratigraphic unit or description.", "Strat"]
    - ["Layer", "Layer identifier", "Schi"]
    - ["Square/Grid", "Excavation square/grid square.", "Quadr"]
    - ["Planum", "Planum", "Plan"]
    - ["Elevation ASL", "Elevation of sample above sea level.", "Prob_üNN"]
    - ["Sediment", "Indicates whether the sample is sediment.", "SedProb"]
    - ["Cultural group", "Cultural group", "KultGr"]

  sample_description:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: sample_description_id
    keys: []
    columns: "@value: entities.sample.keys + @value: entities.sample_description_type.type_names"
    query: |
      select distinct [Projekt], [Befu], [ProbNr],
             [Vorfu], [Trocken], [Strat], [Schi],
             [Quadr], [Plan], [Prob_üNN], [SedProb], [KultGr]
      from [Proben] ;
    foreign_keys:
    - entity: sample_description_type
      local_keys: ["type_name"]
      remote_keys: ["arbodat_code"]
    - entity: sample
      local_keys: "@value: entities.sample.keys"
      remote_keys: "@value: entities.sample.keys"
    unnest:
      id_vars: "@value: entities.sample.keys"
      value_vars: "@value: entities.sample_description_type.type_names"
      var_name: type_name
      value_name: description_value
    drop_duplicates: true
    drop_empty_rows: ["description_value"]
    depends_on: ["sample", "sample_description_type"]
  sample_group:
    source: feature
    surrogate_id: sample_group_id
    keys: ["site_id", "Projekt", "Befu"]
    columns: ["Projekt", "Befu"]
    extra_columns:
      sample_group_name: "Befu"
      sample_group_description:
      sampling_context_id:
      method_id:
    drop_duplicates: true
    depends_on: ["feature"]
  sample_type:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: sample_type_id
    keys: ["ProbTyp"]
    columns: ["ProbTyp", "PrTyp", "Nummer"]
    extra_columns:
      sample_type_name: "ProbTyp"
      sample_type_description: "PrTyp"
    query: "select [ProbTyp], [PrTyp], [Nummer] from [Probentypen] ;"
    depends_on: []
  site:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: site_id
    keys: ["Fustel", "EVNr"]
    columns: ["FustelTyp", "KoordSys", "rWert", "hWert", "üNN"]
    extra_columns:
      site_name: "Fustel"
      national_site_identifier: "EVNr"
      coordinate_system: "KoordSys"
      latitude_dd: "rWert"
      longitude_dd: "hWert"
      altitude: "üNN"
    replacements:
      coordinate_system: "@value: replacements.site.KoordSys"
    query: select distinct p.Fustel, b.FustelTyp, p.EVNr, p.KoordSys, p.rWert, p.hWert, p.[üNN] from Projekte as p inner join ( select distinct Projekt, FustelTyp from Befunde ) as b on p.Projekt = b.Projekt;
    foreign_keys:
    - entity: site_type
      local_keys: ["FustelTyp"]
      remote_keys: ["FustelTyp"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
      how: "left"
    drop_duplicates: ["Fustel", "FustelTyp"]
    check_functional_dependency: true
    depends_on: []
  site_location:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: site_location_id
    keys: []
    columns: "@value: entities.site.keys + @value: entities.location.columns"
    query: |
      select distinct [Fustel], [EVNr], [Ort], [Kreis], [Land], [Staat], [FlurStr] from [Projekte] ;
    unnest:
      id_vars: "@value: entities.site.keys"
      value_vars: "@value: entities.location.columns"
      var_name: location_type
      value_name: location_name
    foreign_keys:
    - entity: site
      local_keys: "@value: entities.site.keys"
      remote_keys: "@value: entities.site.keys"
    - entity: location
      local_keys: ["location_type", "location_name"]
      remote_keys: ["location_type", "location_name"]
    drop_duplicates: "@value: entities.site_location.columns"
    depends_on: ["site", "location"]
  site_natural_region:
    source:
    surrogate_id: site_natural_region_id
    keys: []
    columns: ["Projekt", "Fustel", "EVNr", "NaturE"]
    type: sql
    data_source: arbodat_data
    query: |
      select distinct Projekt, Fustel, EVNr, NaturE
      from Projekte ;
    foreign_keys:
    - entity: natural_region
      local_keys: "@value: entities.natural_region.keys"
      remote_keys: "@value: entities.natural_region.keys"
    - entity: site
      local_keys: "@value: entities.site.keys"
      remote_keys: "@value: entities.site.keys"
    drop_duplicates: "@value: entities.natural_region.keys + @value: entities.site.keys"
    check_functional_dependency: true
    depends_on: ["site", "natural_region"]
  site_property_type:
    source:
    type: fixed
    surrogate_id: site_property_type_id
    surrogate_name: site_property_type
    keys: []
    columns: ["site_property_type", "description", "arbodat_code"]
    values:
    - ["Limes", "Location relative to the Roman Limes (for Roman Imperial period sites)", "Limes"]
    - ["okFustel", "Methodological assessment of the site: adequate or deficient", "okFustel"]
    - ["Map sheet", "TK 25 (Topographic Map 1:25,000)", "TK"]
    - ["EVNr", "LfD excavation record number, according to the State Office for Monument Preservation (LfD)", "EVNr"]
    - ["AnmFustel", "e.g., pollen analysis by NN; soil science by NN; anthropology, etc.", "AnmFustel"]
    depends_on: []
  site_property:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: site_property_id
    keys: ["Fustel"]
    columns: ["EVNr", "okFustel", "Limes", "TK", "AnmFustel"]
    query: |
      select distinct [Fustel], [EVNr], [okFustel], [Limes], [TK], [AnmFustel] from [Projekte] ;
    foreign_keys:
    - entity: site
      local_keys: "@value: entities.site.keys"
      remote_keys: "@value: entities.site.keys"
    - entity: site_property_type
      local_keys: ["@value: entities.site_property_type.surrogate_name"]
      remote_keys: ["@value: entities.site_property_type.surrogate_name"]
    unnest:
      id_vars: ["Fustel", "EVNr"]
      value_vars: "@value: entities.site_property.columns"
      var_name: site_property_type
      value_name: site_property_value
    drop_duplicates: true
    depends_on: ["site", "site_property_type"]
  site_type_group:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: site_type_group_id
    keys: ["FuTypGrup"]
    columns: ["FuTypGrup", "Beschreibung"]
    extra_columns:
      site_type_group: "FuTypGrup"
      description: "Beschreibung"
      arbodat_code: "FuTypGrup"
    query: "select distinct [FuTypGrup], [Beschreibung] from [FundtypGruppe];"
    depends_on: []
  site_type:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: site_type_id
    keys: ["FustelTyp"]
    columns: ["FustelTyp", "FuTypGrup", "Beschreibung"]
    extra_columns:
      site_type: "FustelTyp"
      description: "Beschreibung"
    query: "select [FustelTyp], [FuTypGrup], [Beschreibung] from [Fundstellentyp];"
    drop_duplicates: "@value: entities.site_type.keys"
    foreign_keys:
    - entity: site_type_group
      local_keys: ["FuTypGrup"]
      remote_keys: ["FuTypGrup"]
      constraints:
        allow_unmatched_left: false
        allow_null_keys: false
        cardinality: "many-to-one"
    depends_on: ["site_type_group"]
  _pcodes:
    source:
    data_source: arbodat_data
    type: sql
    surrogate_id: _pcodes_id
    keys: ["PCODE"]
    columns: ["PCODE"]
    query: select distinct [PCODE] from [Details] ;
    drop_duplicates: ["PCODE"]
    depends_on: []
  taxa:
    type: sql
    keys:
    - PCODE
    surrogate_id: taxon_id
    columns:
    - PCODE
    - BNam
    - Name_E
    - Fam
    - S_Od
    - TaxAut
    - Achtung
    data_source: arbodat_lookup
    query: "select distinct t.[PCODE], t.[BNam], t.[Name_E], t.[Fam], t.[S_Od], t.[TaxAut], t.[Achtung]\r\nfrom [ÖkoSozDaten] t ;"
    depends_on:
    - _pcodes
    filters:
    - type: exists_in
      column: PCODE
      other_entity: _pcodes
      other_column: PCODE
    extra_columns:
      system_id:
      author_id:
      genus_id:
      species: BNam
  taxa_use_categories:
    source:
    data_source: arbodat_lookup
    type: sql
    surrogate_id: use_category_id
    keys: []
    columns: ["PCODE", "Ess", "Gar", "Ge", "Hü", "Imp", "Kp", "Med", "Nut", "Öl"]
    query: select [PCODE], [Ess], [Gar], [Ge], [Hü], [Imp], [Kp], [Med], [Nut], [Öl] from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_plant_sociological_behaviour:
    source:
    data_source: arbodat_lookup
    surrogate_id: plant_sociological_behaviour_id
    keys: ["PCODE"]
    columns: ["PCODE", "G", "G_u", "Kl", "Kl_u", "O", "O_u", "Soz", "Soz_u", "U", "U_u", "V", "V_u", "Ökogruppe", "Ökogruppe_u"]
    type: sql
    query: |
      select [PCODE], [G], [G_u], [Kl], [Kl_u], [O], [O_u], [Soz], [Soz_u], [U], [U_u], [V], [V_u], [Ökogruppe], [Ökogruppe_u]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_dominance:
    source:
    data_source: arbodat_lookup
    surrogate_id: dominance_id
    keys: ["PCODE"]
    columns: ["PCODE", "Dom", "Dom_u"]
    type: sql
    query: |
      select [PCODE], [Dom], [Dom_u]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_oberdorfer_characteristics:
    source:
    data_source: arbodat_lookup
    surrogate_id: oberdorfer_characteristics_id
    keys: ["PCODE"]
    columns: ["PCODE", "Anm", "ARE", "BLA", "BLE", "Pio", "Roh", "SozGrup", "WT", "WUA", "WUE", "Zeig"]
    type: sql
    query: |
      select [PCODE], [Anm], [ARE], [BLA], [BLE], [Pio], [Roh], [SozGrup], [WT], [WUA], [WUE], [Zeig]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_persistence:
    source:
    data_source: arbodat_lookup
    surrogate_id: persistence_id
    keys: ["PCODE"]
    columns: ["PCODE", "Bl", "Bl_u", "Leb"]
    type: sql
    query: |
      select [PCODE], [Bl], [Bl_u], [Leb]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_briemle_characteristics:
    source:
    data_source: arbodat_lookup
    surrogate_id: briemle_characteristics_id
    keys: ["PCODE"]
    columns: ["PCODE", "FW", "M", "TKG", "W"]
    type: sql
    query: |
      select [PCODE], [FW], [M], [TKG], [W]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  taxa_ecological_behaviour:
    source:
    data_source: arbodat_lookup
    surrogate_id: ecological_behaviour_id
    keys: ["PCODE"]
    columns: ["PCODE", "F", "F_s", "F_u", "K", "K_u", "L", "L_u", "N", "N_u", "Re", "Re_u", "S", "S_u", "SMet", "T", "T_u"]
    type: sql
    query: |
      select [PCODE], [F], [F_s], [F_u], [K], [K_u], [L], [L_u], [N], [N_u], [Re], [Re_u], [S], [S_u], [SMet], [T], [T_u]
      from [ÖkoSozDaten];
    foreign_keys:
    - entity: taxa
      local_keys: ["PCODE"]
      remote_keys: ["PCODE"]
    depends_on: ["taxa"]
  _project_contact:
    source:
    data_source: arbodat_data
    surrogate_id: contact_id
    keys: []
    columns: ["Projekt", "ArchAusg", "ArchBear", "BotBear"]
    type: sql
    query: |
      select distinct [Projekt], [ArchAusg], [ArchBear], [BotBear] from [Projekte] ;
    unnest:
      id_vars: ["Projekt"]
      value_vars: "@value: entities._project_contact.columns"
      var_name: contact_type
      value_name: contact_name
    drop_duplicates: true
options:
  translations:
    filename: translations.tsv
    delimiter: "\t"
  data_sources:
    sead: '@include: sead-options.yml'
    arbodat_data: '@include: arbodat-data-options.yml'
    arbodat_lookup: '@include: arbodat-lookup-options.yml'
  translation: '@load: options.translations'
  reconciliation: '@include: arbodat-reconciliation.yml'
  finally:
    drop:
      tables:
      - _pcodes
      - _project_contact
      columns:
      - site.surrogate_id
      - project.surrogate_id
      - feature.surrogate_id
      - sample.surrogate_id
      - analysis_entity.surrogate_id
      - abundance.surrogate_id
      - location.surrogate_id
  replacements: '@include: replacements.yml'
  ingesters:
    sead:
      data_source: sead
      options:
        transfer_format: csv
        ignore_columns:
        - date_updated
        - '*_uuid'
        - (*
      policies:
        if_foreign_key_value_is_missing_add_identity_mapping_to_foreign_key_table:
          priority: 1
        set_public_id_to_negative_system_id_for_new_lookups:
          disabled: true
        update_missing_foreign_key_policy:
          tbl_dataset_contacts:
            contact_type_id: 2
            contact_id: 1
        if_lookup_table_is_missing_add_table_using_system_id_as_public_id:
          tables:
          - tbl_abundance_elements
          - tbl_contact_types
          - tbl_dataset_submission_types
          - tbl_location_types
          - tbl_project_types
          - tbl_project_stages
          - tbl_relative_ages
          - tbl_sample_group_sampling_contexts
          - tbl_sample_types
          preallocated_tables: []
        if_lookup_with_no_new_data_then_keep_only_system_id_public_id:
          priority: 9
        drop_ignored_columns:
          priority: 3
          columns:
          - date_updated
          - '*_uuid'
  layout:
    custom:
      abundance:
        x: 675.4454285316694
        y: 167.56055311837812
      abundance_element:
        x: 962.2743047396117
        y: 111.6525872883319
      abundance_element_group:
        x: 1169.9710645152486
        y: 12.88742394036478
      abundance_modification:
        x: 502.884257870446
        y: 654.0964470344421
      abundance_property:
        x: 983.7075204436169
        y: 359.1158609957804
      abundance_property_type:
        x: 1210.2186401800789
        y: 253.23701186617907
      analysis_entity:
        x: 353.0256627524145
        y: 208.1511963802725
      archaeological_period:
        x: 171.37014872809786
        y: -144.6872266243012
      chronological_period:
        x: 381.92704704431367
        y: -98.62950199163335
      contact:
        x: 572.1266349494397
        y: 457.7526737614415
      contact_type:
        x: 372.38471522103293
        y: 486.7093337481287
      coordinate_method_dimension:
        x: -416.98131044948633
        y: 420.84257348715613
      coordinate_system:
        x: 802.767243454006
        y: 868.1095050185854
      cultural_group:
        x: 1025.767243454006
        y: 700.1095050185854
      dataset:
        x: 36.58033627752685
        y: 232.84228038917283
      dataset_contacts:
        x: -937.7075243150333
        y: 35.401769498441645
      dataset_submission:
        x: 807.767243454006
        y: 784.1095050185854
      dataset_submission_type:
        x: 831.267243454006
        y: 700.1095050185854
      dating:
        x: -331.539254227074
        y: 294.1633129676144
      dating_period:
        x: 280.79243137227905
        y: 56.766424215300056
      dimension:
        x: -565.8446387682295
        y: 531.430170955799
      epoch:
        x: 346.32385691585694
        y: -220.54958150285574
      feature:
        x: -261.85848762712976
        y: 6.667457332130798
      feature_property:
        x: -258.6480516125304
        y: -85.45835063626575
      feature_property_type:
        x: -377.93697272135006
        y: -172.32273962374327
      feature_type:
        x: -391.69485280105533
        y: -44.751630244507474
      identification_level:
        x: 987.767243454006
        y: 868.1095050185854
      location:
        x: 240.80344048551564
        y: -365.91650257409935
      location_type:
        x: 99.3552968131274
        y: -457.1783770938211
      master_dataset:
        x: 984.767243454006
        y: 784.1095050185854
      method:
        x: 46.06778742321573
        y: 412.0471670445004
      method_group:
        x: 930.767243454006
        y: 952.1095050185854
      modification_type:
        x: 205.23540855794474
        y: 678.3078447656787
      natural_region:
        x: -788.6847459181952
        y: -393.8123561019895
      natural_region_group:
        x: -876.9868157771434
        y: -291.83795230466865
      project:
        x: -1.0579063090030802
        y: -118.86988641284734
      relative_dating:
        x: 783.267243454006
        y: 952.1095050185854
      sample:
        x: -483.81085456471453
        y: 140.57667249815623
      sample_coordinate:
        x: -544.0180907084795
        y: 315.95731471600413
      sample_description_type:
        x: -883.1224048671289
        y: 403.14856048852783
      sample_description:
        x: -738.2793769888876
        y: 244.6324187237029
      sample_group:
        x: -532.6456344455565
        y: -112.61574188056689
      sample_type:
        x: -694.7424538063067
        y: 71.13266121714865
      site:
        x: -432.4111304264938
        y: -270.32494256427407
      site_location:
        x: -25.87267022499684
        y: -293.55421099775754
      site_natural_region:
        x: -711.7269641662831
        y: -242.42711870489907
      site_property_type:
        x: -386.1362094786371
        y: -446.95222333285426
      site_property:
        x: -556.0219434649146
        y: -398.5723604896434
      site_type_group:
        x: -83.1340253641626
        y: -406.5010002675421
      site_type:
        x: -229.67512365350117
        y: -414.49356569702167
      _pcodes:
        x: 1360.2186401800789
        y: 233.7854956838512
      taxa:
        x: 683.5117779709823
        y: -183.90506369097685
      taxa_use_categories:
        x: 866.2175955732832
        y: -119.26121267340876
      taxa_plant_sociological_behaviour:
        x: 1116.4482242399126
        y: -166.48457206292534
      taxa_dominance:
        x: 1141.1992802307689
        y: -263.6994168980955
      taxa_oberdorfer_characteristics:
        x: 858.3995458732765
        y: -484.53851365088303
      taxa_persistence:
        x: 1000.5880575804882
        y: -365.91210222341095
      taxa_briemle_characteristics:
        x: 504.3537370983374
        y: -322.48697262164836
      taxa_ecological_behaviour:
        x: 618.8894485913696
        y: -448.6066271602773
      _project_contact:
        x: -1326.2713424887481
        y: -447.3177821137942
      source:arbodat_data:
        x: 1073.8656756710398
        y: 1020.5337996663268
      source:arbodat_lookup:
        x: 748.2370990563008
        y: 1293.768618204537
      table:arbodat_lookup:ArchDat:
        x: 348.79451669641014
        y: 1439.1538284819633
      table:arbodat_lookup:ChronoDat:
        x: -76.28340083136447
        y: 1439.1538284819633
      table:arbodat_lookup:KoordSys:
        x: -475.725983191255
        y: 1293.768618204537
      table:arbodat_data:Datierung:
        x: -801.3545598059941
        y: 1020.533799666327
      table:arbodat_data:Proben:
        x: -1013.8935185698813
        y: 652.4055244994877
      table:arbodat_lookup:Epochen:
        x: -1087.7075243150332
        y: 233.78549568385134
      table:arbodat_data:Befunde:
        x: -1013.8935185698815
        y: -184.83453313178507
      source:sead:
        x: -801.3545598059941
        y: -552.9628082986244
      table:sead:tbl_identification_levels:
        x: -475.7259831912558
        y: -826.1976268368342
      table:arbodat_data:Projekte:
        x: -76.2834008313645
        y: -971.5828371142609
      table:sead:tbl_method_groups:
        x: 348.7945166964096
        y: -971.5828371142609
      table:arbodat_lookup:Probentypen:
        x: 748.2370990563008
        y: -826.1976268368346
      table:arbodat_data:Details:
        x: 1073.8656756710395
        y: -552.9628082986249
      table:arbodat_lookup:ÖkoSozDaten:
        x: 1286.4046344349267
        y: -184.83453313178603
    _metadata:
      last_updated: '2026-01-14T19:39:51.890309+00:00'
      layout_version: 1

task_list:
  required_entities:
  - abundance_modification
  - abundance_property
  - contact
  - coordinate_system
  - cultural_group
  - dataset_contacts
  - dataset_submission
  - dataset_submission_type
  - dating
  - dating_period
  - feature_property
  - identification_level
  - master_dataset
  - method_group
  - relative_dating
  - sample_coordinate
  - sample_description
  - site_location
  - site_natural_region
  - site_property
  - taxa_use_categories
  - taxa_plant_sociological_behaviour
  - taxa_dominance
  - taxa_oberdorfer_characteristics
  - taxa_persistence
  - taxa_briemle_characteristics
  - taxa_ecological_behaviour
  - modification_type
  - "abundance"
  - "abundance_property_type"
  - "contact_type"
  - "_project_contact"
  - "dataset"
  - archaeological_period
  - chronological_period
  - "feature_property_type"
  - "coordinate_method_dimension"
  - "sample_description_type"
  - "location"
  - "natural_region"
  - "site_property_type"
  - abundance_element
  - analysis_entity
  - "epoch"
  - "dimension"
  - "location_type"
  - "natural_region_group"
  - "abundance_element_group"
  - "method"
  - "taxa"
  - "sample"
  - _pcodes
  - "sample_type"
  - "sample_group"
  - "feature"
  - feature_type
  - "project"
  - site
  - site_type
  - "site_type_group"
  completed: []
  ignored:
  - taxa_briemle_characteristics
  - taxa_ecological_behaviour
  - taxa_oberdorfer_characteristics
  - taxa_dominance
  - taxa_plant_sociological_behaviour
  - taxa_persistence
