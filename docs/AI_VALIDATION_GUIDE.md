# Shape Shifter YAML Validation Guide for AI Agents

**Purpose**: Quick reference for AI agents validating shapeshifter.yml project files. Concise, rule-focused, no explanatory prose.

**Usage**: Reference when analyzing project configurations, validating changes, or assisting with YAML editing.

---

## Structure Requirements

### Required Top-Level Sections
```yaml
metadata:           # REQUIRED
  name: string      # REQUIRED - project identifier
  type: shapeshifter-project  # REQUIRED - must be exact
  description: string  # OPTIONAL
  version: string   # OPTIONAL

entities:           # REQUIRED - must have at least 1 entity
  entity_name:
    # ... entity config

options:            # OPTIONAL
  data_sources: {}  # Optional data source configs
  layout: {}        # Optional visual layout
```

---

## Entity Types & Required Fields

### All Entity Types
```yaml
entity_name:
  type: <type>              # REQUIRED - see valid types below
  public_id: <column>       # REQUIRED for: fixed entities, FK parents, mapped entities
  keys: [<columns>]         # OPTIONAL - business keys for deduplication
  columns: [<columns>]      # REQUIRED for most types (see exceptions)
```

### Valid Entity Types

| Type | Required Fields | Optional Fields | Notes |
|------|----------------|-----------------|-------|
| `fixed` | `columns`, `values`, `public_id` | `foreign_keys`, `extra_columns` | Values array width must match columns length |
| `sql` | `data_source`, (`query` OR `table`) | `columns`, `public_id`, `keys`, `foreign_keys` | Query with placeholders or table name |
| `csv` | `filename` or `options.filename` | `columns`, `public_id`, `keys`, `foreign_keys` | CSV file loader |
| `xlsx` | `filename` or `options.filename`, `sheet_name` or `options.sheet_name` | `columns`, `public_id`, `keys`, `foreign_keys` | Excel file XLSX format |
| `openpyxl` | `filename` or `options.filename`, `sheet_name` or `options.sheet_name` | `columns`, `public_id`, `keys`, `foreign_keys` | Excel file via openpyxl |
| `entity` | `source` | `columns`, `public_id`, `keys`, `foreign_keys`, `drop_duplicates`, `drop_empty_rows`, `extra_columns` | Derived from another entity |

---

## Three-Tier Identity System

### 1. `system_id` (Local Sequential)
- **Always present** - auto-generated by system
- **Column name**: Standardized to `"system_id"`
- **Values**: Sequential 1, 2, 3... (reset per entity)
- **Usage**: ALL FK relationships use system_id values
- **Validation**: Never specify manually in YAML (except fixed entities)

### 2. `keys` (Business Keys)
```yaml
keys: [column_name, ...]  # OPTIONAL - list of columns
```
- Used for deduplication (`drop_duplicates: true`)
- Used for FK matching (business key joins)
- Examples: `["specimen_id"]`, `["location_name", "site_code"]`

### 3. `public_id` (Target Schema Identity)
```yaml
public_id: target_column_name  # Column name in target system
```
- **Dual purpose**:
  1. Column name for target system's PK
  2. Column values hold mapped IDs from `mappings.yml`
- **Required for**:
  - Fixed entities (MUST have)
  - Entities with FK children (defines FK column name)
  - Entities in `mappings.yml`

### Identity Column Rules

**Fixed entities**:
```yaml
# ✅ CORRECT - columns explicitly list system_id and public_id
columns: [system_id, sample_type_id, type_name, description]
values:
  - [1, null, "Type A", "Description"]
```

**Other entity types**:
```yaml
# ✅ CORRECT - system_id/public_id auto-managed, not in columns list
columns: [type_name, description]  # Identity cols added automatically
```

---

## Foreign Key Validation

### Basic Structure
```yaml
foreign_keys:
  - entity: <target_entity>      # REQUIRED - must exist
    local_keys: [<columns>]      # REQUIRED - must exist in source
    remote_keys: [<columns>]     # REQUIRED - must exist in target
```

### Critical Rules

**✅ Valid local_keys sources**:
1. Regular columns from source data
2. Columns from `source` entity (if type=entity)
3. Columns added via `extra_columns`

**✅ Valid patterns**:
```yaml
# Pattern 1: Regular column FK
foreign_keys:
  - entity: location
    local_keys: [location_id]
    remote_keys: [system_id]

# Pattern 2: Business key FK
foreign_keys:
  - entity: site
    local_keys: [site_name]
    remote_keys: [site_name]

# Pattern 3: extra_columns + FK (THIS IS VALID!)
extra_columns:
  description_type_id: 1
foreign_keys:
  - entity: sample_description_type
    local_keys: [description_type_id]  # References extra_columns
    remote_keys: [system_id]
```

**❌ Invalid patterns**:
```yaml
# Missing target entity
foreign_keys:
  - entity: nonexistent_entity
    local_keys: [col]
    remote_keys: [id]

# Column doesn't exist
foreign_keys:
  - entity: location
    local_keys: [missing_column]
    remote_keys: [system_id]
```

---

## Extra Columns Feature

### Purpose
Add constant-value columns OR copy existing columns to entity.

### Syntax
```yaml
extra_columns:
  new_column_name: constant_value    # String, number, or reference
```

### Valid Patterns

**✅ Constant values**:
```yaml
extra_columns:
  record_type_id: '14'
  status: 'active'
  abundance: '1'
```

**✅ Copy existing column**:
```yaml
extra_columns:
  parent_id: child_id  # Copies child_id values to new parent_id column
```

**✅ Extra columns + Foreign keys** (VALID DESIGN PATTERN):
```yaml
# This is INTENTIONAL, not an error!
extra_columns:
  description_type_id: 1  # Add constant column

foreign_keys:
  - entity: sample_description_type
    local_keys: [description_type_id]  # FK references extra_columns
    remote_keys: [system_id]
```

---

## Dependency Validation

### Dependency Sources
Entities can depend on others via:
1. **Explicit**: `depends_on: [entity1, entity2]`
2. **Implicit**: `source: entity` (for type=entity)
3. **Implicit**: `foreign_keys[].entity` references

### Circular Dependency Rules

**❌ Invalid - Circular dependencies**:
```yaml
entity1:
  source: entity2
entity2:
  source: entity1  # CIRCULAR!
```

**❌ Invalid - Self-dependency**:
```yaml
entity1:
  foreign_keys:
    - entity: entity1  # SELF-REFERENCE!
```

**✅ Valid - Linear chain**:
```yaml
entity1:
  source: entity2
entity2:
  source: entity3
entity3:
  type: sql
```

### Processing Order
- Entities processed in topological order (dependencies first)
- Cycles prevent processing
- Use dependency graph to validate

---

## Data Source Validation

### SQL Entities
```yaml
type: sql
data_source: <name>     # REQUIRED - must exist in options.data_sources
query: "SELECT ..."     # OPTIONAL - if not provided, need table
table: "table_name"     # OPTIONAL - if not provided, need query
```

**Rules**:
- Must have EITHER `query` OR `table` (not both)
- `data_source` must be defined in `options.data_sources` or global config
- Query placeholders: `{entity_name}` for referencing other entities

### File Entities (csv, xlsx, openpyxl)
```yaml
type: xlsx
filename: "file.xlsx"           # REQUIRED (or in options)
sheet_name: "Sheet1"            # REQUIRED for Excel (or in options)
options:
  filename: "alt_location.xlsx"  # Alternative location
  sheet_name: "Sheet1"           # Alternative location
  location: global               # Optional: 'local' or 'global'
```

**Rules**:
- Excel types MUST specify `sheet_name`
- `filename` can be in root or `options`
- `location: global` references `${GLOBAL_DATA_DIR}`

---

## Common Validation Errors

### 1. Column Mismatch (Fixed Entities)
```yaml
# ❌ ERROR - 4 columns but values have 2 items
columns: [system_id, sample_type_id, type_name, description]
values:
  - [1, null]  # MISMATCH!

# ✅ CORRECT
columns: [system_id, sample_type_id, type_name, description]
values:
  - [1, null, "Type A", "Description"]
```

### 2. Missing public_id
```yaml
# ❌ ERROR - Fixed entity without public_id
type: fixed
columns: [system_id, name]
values: [[1, "Test"]]
# Missing: public_id: <column>

# ❌ ERROR - Entity with FK children but no public_id
parent:
  type: sql
  # Missing: public_id: parent_id
child:
  foreign_keys:
    - entity: parent
      local_keys: [parent_id]  # What column to use?
```

### 3. Missing Required Fields
```yaml
# ❌ ERROR - SQL entity without data_source
type: sql
query: "SELECT * FROM table"
# Missing: data_source: <name>

# ❌ ERROR - Excel entity without sheet_name
type: xlsx
filename: "data.xlsx"
# Missing: sheet_name: <name>

# ❌ ERROR - Derived entity without source
type: entity
columns: [col1]
# Missing: source: <entity_name>
```

### 4. Invalid References
```yaml
# ❌ ERROR - FK references non-existent entity
foreign_keys:
  - entity: nonexistent
    local_keys: [id]
    remote_keys: [id]

# ❌ ERROR - Source entity doesn't exist
type: entity
source: nonexistent
```

### 5. Incorrect Identity Handling
```yaml
# ❌ ERROR - Non-fixed entity with system_id in columns
type: entity
source: datasheet
columns: [system_id, sample_id, name]  # Don't manually add system_id

# ✅ CORRECT
type: entity
source: datasheet
columns: [sample_id, name]  # system_id auto-managed
```

---

## Special Features

### Drop Duplicates
```yaml
drop_duplicates: true  # Uses 'keys' field for deduplication
keys: [specimen_id]
```

### Drop Empty Rows
```yaml
drop_empty_rows: [column1, column2]  # Drop if ALL specified columns are null
# OR
drop_empty_rows: true  # Drop if ALL columns are null
```

### Materialized Entities
```yaml
materialized:
  enabled: true
  timestamp: "2024-01-15T10:30:00Z"
  source_hash: "abc123"
```
- Cached/frozen entity data
- FK references show historical dependencies
- Validation should allow materialized entities without re-checking data

---

## Validation Checklist

When validating a shapeshifter.yml file, check:

### Structure
- [ ] Has `metadata` section with required fields
- [ ] Has `entities` section with at least one entity
- [ ] All entities have required fields for their type

### Identity System
- [ ] Fixed entities: `system_id` and `public_id` in columns list
- [ ] Other entities: `system_id`/`public_id` NOT in columns list
- [ ] Entities with FK children have `public_id` defined
- [ ] `public_id` column name makes sense for target system

### Foreign Keys
- [ ] All `foreign_keys[].entity` references exist
- [ ] All `local_keys` exist (in columns, source, or extra_columns)
- [ ] All `remote_keys` exist in target entity
- [ ] No self-references
- [ ] Extra columns + FK is VALID pattern (not an error)

### Dependencies
- [ ] All `source` entities exist
- [ ] All `depends_on` entities exist
- [ ] No circular dependencies between entities
- [ ] Processing order is valid (topological sort possible)

### Data Sources
- [ ] SQL entities have `data_source` defined
- [ ] SQL entities have EITHER `query` OR `table`
- [ ] File entities have `filename` (or in options)
- [ ] Excel entities have `sheet_name` (or in options)

### Data Integrity
- [ ] Fixed entities: columns length = values array width
- [ ] Derived entities have `source` specified
- [ ] Column references are consistent
- [ ] No orphaned foreign keys

---

## Valid Pattern Library

### Pattern: Lookup Table with Constant FK
```yaml
sample_description:
  type: entity
  source: datasheet
  columns: [biological_age]
  extra_columns:
    description_type_id: 1  # Constant value
  foreign_keys:
    - entity: sample_description_type
      local_keys: [description_type_id]
      remote_keys: [system_id]

sample_description_type:
  type: fixed
  public_id: sample_description_type_id
  columns: [system_id, sample_description_type_id, type_name]
  values:
    - [1, null, "Biological Age"]
```

### Pattern: Hierarchical Taxonomy
```yaml
taxa_tree_master:
  type: fixed
  public_id: taxon_id
  columns: [system_id, taxon_id]
  values: [[1, null]]
  extra_columns:
    species: groenlandicus
    genus_id: '1'
  foreign_keys:
    - entity: tbl_taxa_tree_genera
      local_keys: [genus_id]
      remote_keys: [system_id]

tbl_taxa_tree_genera:
  type: fixed
  public_id: genus_id
  columns: [system_id, genus_id]
  values: [[1, null]]
  extra_columns:
    genus_name: Pagophilus
```

### Pattern: Business Key Join
```yaml
physical_samples:
  type: entity
  source: datasheet
  columns: [lab_nr, site]
  foreign_keys:
    - entity: site
      local_keys: [site]
      remote_keys: [site_name]  # Join on business key, not ID

site:
  type: openpyxl
  public_id: site_id
  keys: [site_name]  # Business key
  columns: [site_name, latitude, longitude]
  options:
    filename: sites.xlsx
    sheet_name: sites
```

---

## Quick Reference: Entity Type Decision Tree

```
Is data hard-coded in YAML?
├─ YES → type: fixed
│         Need: columns, values, public_id
└─ NO → Is data from database?
    ├─ YES → type: sql
    │         Need: data_source, (query OR table)
    └─ NO → Is data from file?
        ├─ CSV → type: csv
        │         Need: filename
        ├─ XLSX → type: xlsx OR openpyxl
        │         Need: filename, sheet_name
        └─ Derived from entity → type: entity
                  Need: source
```

---

## Environment Variables & Directives

### Valid Patterns
```yaml
# Environment variable
data_source: ${DB_CONNECTION}

# Include directive
options:
  data_sources:
    sead: '@include: ${GLOBAL_DATA_SOURCE_DIR}/sead-options.yml'

# Value directive
some_field: '@value: path.to.config.key'
```

**Resolution**:
- Directives preserved in API/YAML layer
- Resolved at API → Core boundary
- Core layer always has resolved values

---

## Integration Notes

This guide should be referenced from main AI instruction files:

**In `.github/copilot-instructions.md`**:
```markdown
## YAML Validation
When validating shapeshifter.yml files, refer to [docs/AI_VALIDATION_GUIDE.md](docs/AI_VALIDATION_GUIDE.md) for:
- Quick validation checklist
- Common error patterns
- Valid configuration examples
```

**In `AGENTS.md`**:
```markdown
### Project Validation
Use [docs/AI_VALIDATION_GUIDE.md](docs/AI_VALIDATION_GUIDE.md) when analyzing project configurations.
Focus on structural issues, not intentional design patterns (e.g., extra_columns + FK is valid).
```

---

## Version History

- **v1.0** (2026-02-19): Initial version for AI agent validation guidance
