# FK Editing UX Enhancement

## Overview

Enhanced the foreign key editing experience by providing intelligent column suggestions based on static analysis of entity configurations. Users now get categorized picklists of available columns when editing FK relationships, eliminating guesswork and reducing errors.

## Features

### 1. Column Introspection Service (Backend)

**Location**: `backend/app/services/column_introspection_service.py`

Analyzes entity configurations without executing normalization to discover available columns categorized by source:

- **Keys**: Business/natural keys from `keys` field
- **Explicit**: Columns from `columns` field
- **Extra**: Computed columns from `extra_columns` dict
- **Unnested**: Columns generated by unnesting (value_id, value_name, var_name, id_vars)
- **Foreign Key**: Columns inherited from parent entities (parent's public_id)
- **System**: Always-available system columns (system_id, public_id)
- **Directives**: @value directive suggestions for dynamic references

### 2. API Endpoint

**Endpoint**: `GET /api/v1/projects/{project_name}/entities/{entity_name}/columns`

**Query Parameters**:
- `remote_entity` (optional): Remote entity name for FK relationship

**Response**:
```json
{
  "local_columns": {
    "explicit": ["col1", "col2"],
    "keys": ["key1"],
    "extra": ["computed_col"],
    "unnested": ["value_id", "value_name"],
    "foreign_key": ["parent_id"],
    "system": ["system_id", "entity_id"],
    "directives": ["@value:entities.entity.keys"]
  },
  "remote_columns": { /* same structure */ }
}
```

### 3. Frontend Composable

**Location**: `frontend/src/composables/useColumnIntrospection.ts`

Provides reactive column fetching with caching:

```typescript
const { getAvailableColumns, flattenColumns } = useColumnIntrospection()

// Fetch columns for an entity
const result = await getAvailableColumns(projectName, entityName, remoteEntity)

// Convert to flat list with categories
const suggestions = flattenColumns(result.local_columns)
```

### 4. Enhanced FK Editor Component

**Location**: `frontend/src/components/entities/ForeignKeyEditor.vue`

#### Features:
- **Lazy loading**: Columns fetched on first focus (efficient)
- **Categorized suggestions**: Items grouped by source with subtitles
- **Caching**: Column lists cached per entity (no redundant API calls)
- **Manual entry**: Combobox allows freeform text for flexibility
- **@value directive support**: Can reference other YAML paths dynamically

#### UI Improvements:
- Local/Remote key comboboxes show column suggestions with categories
- Chips display selected columns cleanly
- Category labels (Keys, Explicit, Extra, etc.) help users understand column origins
- Still allows manual entry for edge cases

## Usage

### For Users

1. **Open entity editor** and navigate to Foreign Keys section
2. **Click on Local Keys or Remote Keys** combobox
3. **Select from categorized suggestions** or type custom value
4. **Use @value directives** for dynamic references (e.g., `@value:entities.site.keys`)

### For Developers

#### Adding new column categories:

1. Update `ColumnAvailability` model in service
2. Add extraction logic in `_analyze_entity()`
3. Update `flattenColumns()` in composable to include new category
4. Categories appear automatically in UI

#### Testing:

```bash
# Backend tests
uv run pytest backend/tests/services/test_column_introspection_service.py -v

# Manual testing
# 1. Start backend: make backend-run
# 2. Start frontend: make frontend-run
# 3. Open entity editor, click FK comboboxes
```

## Architecture

### Static Analysis Approach

The system uses **static analysis** (no normalization execution) to discover columns:

1. Reads entity configuration from YAML
2. Extracts columns from various sources (columns, keys, extra_columns, unnest, FKs)
3. Returns categorized list via API
4. Frontend caches and displays in combobox

**Benefits**:
- Fast (no data processing)
- Works before entity is validated
- Helps users construct correct configurations

### Column Discovery Algorithm

```
For entity E:
  1. Explicit = E.columns
  2. Keys = E.keys
  3. Extra = E.extra_columns.keys()
  4. Unnested = analyze_unnest_config(E.unnest)
  5. FK Columns = [parent.public_id for parent in E.foreign_keys]
  6. System = ["system_id", E.public_id]
  7. Directives = generate_value_directive_suggestions(E)
```

### Caching Strategy

- **Backend**: No caching (config can change frequently)
- **Frontend**: Per-entity cache in component state (cleared on entity change)
- **Pattern**: Lazy load on first focus, reuse until parent entity changes

## Future Enhancements

### Phase 2: @value Directive Validation
- Validate @value paths against project structure
- Provide autocomplete for YAML paths
- Warn on invalid references

### Phase 3: UI Polish
- Add visual indicators for directive vs static columns
- Highlight recommended columns based on FK semantics
- Show tooltips explaining column sources

### Phase 4: Smart Defaults
- Auto-suggest FK columns based on naming conventions
- Detect common patterns (name → name_id)
- Pre-populate based on parent keys

## Implementation Timeline

- **Phase 1 (Backend + Frontend)**: ✅ Complete (2 days)
- **Phase 2 (@value Validation)**: ✅ Complete (1 day)
- **Phase 3 (UI Polish)**: Planned (1 day)
- **Phase 4 (Smart Defaults)**: Future (2 days)

## Phase 2: @value Directive Validation (✅ Complete)

### Features Delivered

1. **Backend Directive Validator** (`backend/app/services/directive_validator.py`)
   - Validates @value paths against project structure
   - Resolves paths through nested config (entities, options)
   - Context-aware FK validation (ensures list types)
   - Generates helpful suggestions for invalid paths
   - Discovers all valid directive paths in project

2. **API Endpoints** (`backend/app/api/v1/endpoints/directives.py`)
   - `POST /projects/{name}/validate-directive` - Validate single directive
   - `GET /projects/{name}/valid-directives` - Get all valid paths

3. **Frontend Composable** (`frontend/src/composables/useDirectiveValidation.ts`)
   - Reactive directive validation
   - Client-side directive detection (`isDirective()`)
   - Path extraction helper (`extractPath()`)
   - Valid directives fetching

4. **Enhanced FK Editor**
   - Real-time validation of @value directives
   - Error messages with suggestions below comboboxes
   - Context-aware validation (checks FK semantics)
   - Visual feedback (red error state when invalid)

### Validation Features

**Path Resolution**:
- Validates against actual project structure
- Supports nested paths (e.g., `@value:options.ingesters.sead.host`)
- Checks entity existence
- Verifies field availability

**FK-Specific Validation**:
- Ensures @value resolves to a list (FK keys requirement)
- Provides entity-specific suggestions
- Context-aware error messages

**Helpful Suggestions**:
- Suggests valid paths when resolution fails
- Entity-specific suggestions for FK context
- Fallback to root suggestions if empty project

### User Experience

**Before Phase 2**:
- No validation of @value directives
- Errors only discovered at runtime
- No guidance on valid paths

**After Phase 2**:
- Immediate validation feedback
- Clear error messages with suggestions
- Visual indicators (error state + messages)
- Example: "Try: @value:entities.location.keys"

### Testing

- ✅ 14/14 directive validator tests passing
- Tests cover: valid paths, invalid entities, invalid fields, FK context, suggestions, empty projects
- Full validation flow tested (backend + API integration)

## Related Files

**Backend**:
- `backend/app/services/column_introspection_service.py`
- `backend/app/services/directive_validator.py` (Phase 2)
- `backend/app/api/v1/endpoints/columns.py`
- `backend/app/api/v1/endpoints/directives.py` (Phase 2)
- `backend/tests/services/test_column_introspection_service.py`
- `backend/tests/services/test_directive_validator.py` (Phase 2)

**Frontend**:
- `frontend/src/composables/useColumnIntrospection.ts`
- `frontend/src/composables/useDirectiveValidation.ts` (Phase 2)
- `frontend/src/components/entities/ForeignKeyEditor.vue`

## Testing Coverage

**Phase 1**:
- ✅ Extract explicit columns
- ✅ Extract business keys
- ✅ Extract extra columns
- ✅ Extract unnested columns
- ✅ Extract FK columns
- ✅ Extract system columns
- ✅ Generate directive suggestions
- ✅ Handle nonexistent entities
- ✅ Support remote entity column fetching

**Phase 2**:
- ✅ Validate valid @value directives
- ✅ Reject directives without @value: prefix
- ✅ Validate path depth requirements
- ✅ Detect invalid entities
- ✅ Detect invalid fields
- ✅ FK-specific validation (list type requirement)
- ✅ Generate helpful suggestions
- ✅ Handle nested path resolution
- ✅ Handle empty projects gracefully
