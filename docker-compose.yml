version: '3.8'

services:
  # Shape Shifter Application (Backend serves Frontend)
  app:
    build:
      context: .
      dockerfile: docker/Dockerfile
      args:
        # Build-time environment variables for frontend build
        VITE_API_BASE_URL: ""
        VITE_ENV: production
        VITE_ENABLE_ANALYTICS: "false"
        VITE_ENABLE_DEBUG: "false"
    container_name: shapeshifter-app
    ports:
      - "8012:8012"  # Backend API + Frontend UI
    environment:
      # Runtime environment variables
      - ENVIRONMENT=production
      - LOG_LEVEL=info
      - PYTHONUNBUFFERED=1
      # Projects directory
      - PROJECTS_DIR=/app/projects
    volumes:
      # Persistent data volumes
      - ./projects:/app/projects       # Project YAML files
      - ./input:/app/input:ro          # Input data (read-only)
      - ./output:/app/output           # Output data
      - ./backups:/app/backups         # Auto-fix backups
      - ./logs:/app/logs               # Application logs
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8012/api/v1/health').read()"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    networks:
      - shapeshifter-network

networks:
  shapeshifter-network:
    driver: bridge

volumes:
  projects-data:
    driver: local
