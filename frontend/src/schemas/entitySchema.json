{
  "$defs": {
    "AppendConfig": {
      "description": "Configuration for appending data to an entity.",
      "properties": {
        "type": {
          "description": "Type of data to append",
          "enum": [
            "fixed",
            "sql"
          ],
          "title": "Type",
          "type": "string"
        },
        "values": {
          "anyOf": [
            {
              "items": {
                "items": {},
                "type": "array"
              },
              "type": "array"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Fixed values to append",
          "title": "Values"
        },
        "data_source": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Data source name for SQL",
          "title": "Data Source"
        },
        "query": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "SQL query for appending data",
          "title": "Query"
        }
      },
      "required": [
        "type"
      ],
      "title": "AppendConfig",
      "type": "object"
    },
    "FilterConfig": {
      "description": "Configuration for post-extraction filters.",
      "properties": {
        "type": {
          "description": "Filter type (e.g., 'exists_in')",
          "title": "Type",
          "type": "string"
        },
        "entity": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Related entity for filter",
          "title": "Entity"
        },
        "column": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Column to filter on",
          "title": "Column"
        },
        "remote_column": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Remote column for comparison",
          "title": "Remote Column"
        }
      },
      "required": [
        "type"
      ],
      "title": "FilterConfig",
      "type": "object"
    },
    "ForeignKeyConfig": {
      "description": "Configuration for a foreign key relationship.",
      "properties": {
        "entity": {
          "description": "Remote entity name",
          "title": "Entity",
          "type": "string"
        },
        "local_keys": {
          "description": "Local key columns",
          "items": {
            "type": "string"
          },
          "title": "Local Keys",
          "type": "array"
        },
        "remote_keys": {
          "description": "Remote key columns",
          "items": {
            "type": "string"
          },
          "title": "Remote Keys",
          "type": "array"
        },
        "how": {
          "default": "inner",
          "description": "Join type",
          "enum": [
            "left",
            "inner",
            "outer",
            "right",
            "cross"
          ],
          "title": "How",
          "type": "string"
        },
        "extra_columns": {
          "anyOf": [
            {
              "additionalProperties": {
                "type": "string"
              },
              "type": "object"
            },
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            },
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Additional columns to include from remote entity",
          "title": "Extra Columns"
        },
        "drop_remote_id": {
          "default": false,
          "description": "Drop remote surrogate ID after merge",
          "title": "Drop Remote Id",
          "type": "boolean"
        },
        "constraints": {
          "anyOf": [
            {
              "$ref": "#/$defs/ForeignKeyConstraints"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Foreign key constraints"
        }
      },
      "required": [
        "entity"
      ],
      "title": "ForeignKeyConfig",
      "type": "object"
    },
    "ForeignKeyConstraints": {
      "description": "Constraints for foreign key relationships.",
      "properties": {
        "cardinality": {
          "anyOf": [
            {
              "enum": [
                "one_to_one",
                "many_to_one",
                "one_to_many",
                "many_to_many"
              ],
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Cardinality"
        },
        "allow_unmatched_left": {
          "anyOf": [
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Allow Unmatched Left"
        },
        "allow_unmatched_right": {
          "anyOf": [
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Allow Unmatched Right"
        },
        "allow_row_decrease": {
          "anyOf": [
            {
              "type": "boolean"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Allow Row Decrease"
        },
        "require_unique_left": {
          "default": false,
          "title": "Require Unique Left",
          "type": "boolean"
        },
        "require_unique_right": {
          "default": false,
          "title": "Require Unique Right",
          "type": "boolean"
        },
        "allow_null_keys": {
          "default": true,
          "title": "Allow Null Keys",
          "type": "boolean"
        }
      },
      "title": "ForeignKeyConstraints",
      "type": "object"
    },
    "UnnestConfig": {
      "description": "Configuration for unnesting (melting) wide data to long format.",
      "properties": {
        "id_vars": {
          "description": "Identifier columns to keep",
          "items": {
            "type": "string"
          },
          "title": "Id Vars",
          "type": "array"
        },
        "value_vars": {
          "description": "Columns to melt",
          "items": {
            "type": "string"
          },
          "title": "Value Vars",
          "type": "array"
        },
        "var_name": {
          "description": "Name for the variable column",
          "title": "Var Name",
          "type": "string"
        },
        "value_name": {
          "description": "Name for the value column",
          "title": "Value Name",
          "type": "string"
        }
      },
      "required": [
        "id_vars",
        "value_vars",
        "var_name",
        "value_name"
      ],
      "title": "UnnestConfig",
      "type": "object"
    }
  },
  "description": "Schema for a single entity definition (table/view/query configuration)",
  "properties": {
    "name": {
      "description": "Entity name (snake_case)",
      "title": "Name",
      "type": "string"
    },
    "type": {
      "anyOf": [
        {
          "enum": [
            "entity",
            "sql",
            "fixed",
            "csv",
            "xlsx",
            "openpyxl"
          ],
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Data source type",
      "title": "Type"
    },
    "source": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Source entity name",
      "title": "Source"
    },
    "data_source": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Data source name for SQL type",
      "title": "Data Source"
    },
    "query": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "SQL query for SQL type",
      "title": "Query"
    },
    "system_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": "system_id",
      "description": "Local auto-incrementing identifier (always 'system_id')",
      "title": "System Id"
    },
    "public_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Public identifier for target system and FK column naming (e.g., 'sample_type_id')",
      "title": "Public Id",
      "pattern": ".*_id$",
      "examples": [
        "sample_type_id",
        "location_id"
      ]
    },
    "surrogate_id": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "DEPRECATED: Use system_id/public_id instead. Kept for backward compatibility.",
      "title": "Surrogate Id"
    },
    "keys": {
      "description": "Business/natural key columns from source data",
      "items": {
        "type": "string"
      },
      "title": "Keys",
      "type": "array"
    },
    "columns": {
      "description": "Columns to extract",
      "items": {
        "type": "string"
      },
      "title": "Columns",
      "type": "array"
    },
    "extra_columns": {
      "additionalProperties": true,
      "description": "Additional computed columns",
      "title": "Extra Columns",
      "type": "object"
    },
    "foreign_keys": {
      "description": "Foreign key relationships",
      "items": {
        "$ref": "#/$defs/ForeignKeyConfig"
      },
      "title": "Foreign Keys",
      "type": "array"
    },
    "unnest": {
      "anyOf": [
        {
          "$ref": "#/$defs/UnnestConfig"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Unnest configuration"
    },
    "filters": {
      "description": "Post-extraction filters",
      "items": {
        "$ref": "#/$defs/FilterConfig"
      },
      "title": "Filters",
      "type": "array"
    },
    "append": {
      "description": "Data to append",
      "items": {
        "$ref": "#/$defs/AppendConfig"
      },
      "title": "Append",
      "type": "array"
    },
    "depends_on": {
      "description": "Processing dependencies",
      "items": {
        "type": "string"
      },
      "title": "Depends On",
      "type": "array"
    },
    "drop_duplicates": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      ],
      "default": false,
      "description": "Drop duplicate rows",
      "title": "Drop Duplicates"
    },
    "drop_empty_rows": {
      "anyOf": [
        {
          "type": "boolean"
        },
        {
          "items": {
            "type": "string"
          },
          "type": "array"
        }
      ],
      "default": false,
      "description": "Drop empty rows",
      "title": "Drop Empty Rows"
    },
    "check_column_names": {
      "default": true,
      "description": "Validate column names",
      "title": "Check Column Names",
      "type": "boolean"
    },
    "values": {
      "anyOf": [
        {
          "items": {
            "items": {},
            "type": "array"
          },
          "type": "array"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Fixed values for 'fixed' type entities",
      "title": "Values"
    }
  },
  "required": [],
  "title": "ShapeShifter Entity Definition",
  "type": "object",
  "$schema": "http://json-schema.org/draft-07/schema#"
}
